<!DOCTYPE html>
<html lang="en">
<script src="FRVSE.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Map</title>
    <style>
        #pixelMap {
            width: 320px;
            height: 200px;
            border: 3px solid black;
        }
        .pixel {
            width: 1px;
            height: 1px;
            float: left;
        }
		
		.tbl_scrl {
			overflow-x: auto; /* Horizontal scroll */
			overflow-y: auto; /* Vertical scroll */
			max-height: 300px; /* Set a maximum height if needed */
			/*max-width: 750px;  Set a maximum height if needed */
			/* You can adjust the styles according to your design requirements */
		}
		
		#hex_view thead {
		  position: sticky; /* Make the header sticky */
		  top: 0; /* Stick it to the top */
		  z-index: 1; /* Ensure it appears above the scrolling content */
		}
		
		#register_table td, th{
			text-align: center;
			background-color: grey;
			color: black;
		}
    </style>
</head>
<body>
	<head>FRVSE - Franto RISC-V Simple Emulator (RISCV32IM)</head>
	<br>
	<a href="">See how to use FRVSE</a>.
	
	<div id="screenid">
		<div id="pixelMap"></div>
		<button type="button" onclick="start_frvse()">Start FRVSE</button>
		<button type="button" onclick="stop_frvse()">Stop FRVSE</button>
		<button type="button" onclick="step_frvse()">Step FRVSE</button>
		<button type="button" onclick="reset_frvse()">Reset FRVSE</button>
		<br>
		<input type="file" id="rom_fileid" name="rom_file"/>
		<br>
		<input type="file" id="mm_fileid" name="mm_file"/>
	</div>

	<div id="register_table">
		<table>
			<tr>
				<td colspan="2"><button type="button" onclick="reg_mode(true)">DEC</button></th>
				<td colspan="2"><button type="button" onclick="reg_mode(false)">HEX</button></th>
			</tr>
			<tr>
				<td colspan="2">PC</td>
				<td id="pcid" colspan="2">0x0</td>
			</tr>
			<tr>
				<th>Name</th>
				<th>Value</th>
				<th>Name</th>
				<th>Value</th>
			</tr>
			<tr>
				<td>x0 zero</td>
				<td id="x0id">0x0</td>
				<td>x16 a6</td>
				<td id="x16id">0x0</td>
			</tr>
			<tr>
				<td>x1 ra</td>
				<td id="x1id">0x0</td>
				<td>x17 a7</td>
				<td id="x17id">0x0</td>
			</tr>
			<tr>
				<td>x2 sp</td>
				<td id="x2id">0x0</td>
				<td>x18 s2</td>
				<td id="x18id">0x0</td>
			</tr>
			<tr>
				<td>x3 gp</td>
				<td id="x3id">0x0</td>
				<td>x19 s3</td>
				<td id="x19id">0x0</td>
			</tr>
			<tr>
				<td>x4 tp</td>
				<td id="x4id">0x0</td>
				<td>x20 s4</td>
				<td id="x20id">0x0</td>
			</tr>
			<tr>
				<td>x5 t0</td>
				<td id="x5id">0x0</td>
				<td>x21 s5</td>
				<td id="x21id">0x0</td>
			</tr>
			<tr>
				<td>x6 t1</td>
				<td id="x6id">0x0</td>
				<td>x22 s6</td>
				<td id="x22id">0x0</td>
			</tr>
			<tr>
				<td>x7 t2</td>
				<td id="x7id">0x0</td>
				<td>x23 s7</td>
				<td id="x23id">0x0</td>
			</tr>
			<tr>
				<td>x8 s0/fp</td>
				<td id="x8id">0x0</td>
				<td>x24 s8</td>
				<td id="x24id">0x0</td>
			</tr>
			<tr>
				<td>x9 s1</td>
				<td id="x9id">0x0</td>
				<td>x25 s9</td>
				<td id="x25id">0x0</td>
			</tr>
			<tr>
				<td>x10 a0</td>
				<td id="x10id">0x0</td>
				<td>x26 s10</td>
				<td id="x26id">0x0</td>
			</tr>
			<tr>
				<td>x11 a1</td>
				<td id="x11id">0x0</td>
				<td>x27 s11</td>
				<td id="x27id">0x0</td>
			</tr>
			<tr>
				<td>x12 a2</td>
				<td id="x12id">0x0</td>
				<td>x28 t3</td>
				<td id="x28id">0x0</td>
			</tr>
			<tr>
				<td>x13 a3</td>
				<td id="x13id">0x0</td>
				<td>x29 t4</td>
				<td id="x29id">0x0</td>
			</tr>
			<tr>
				<td>x14 a4</td>
				<td id="x14id">0x0</td>
				<td>x30 t5</td>
				<td id="x30id">0x0</td>
			</tr>
			<tr>
				<td>x15 a5</td>
				<td id="x15id">0x0</td>
				<td>x31 t6</td>
				<td id="x31id">0x0</td>
			</tr>
		</table>
	</div>

	<button type="button" onclick="show_memory(ROM_MEMORY, 'ROM Memory')">Show ROM</button>
	<button type="button" onclick="show_memory(RAM_MEMORY, 'RAM Memory')">Show RAM</button>
	<button type="button" onclick="show_memory(MM_MEMORY, 'Mass Memory')">Show Mass Memory</button>
	<button type="button" onclick="show_memory(VRAM_MEMORY, 'VRAM Memory')">Show Video Memory</button>
	<button type="button" onclick="show_memory(CHARACTER_MEMORY, 'Character Memory')">Character Memory</button>
	<br>
	<b id="memory_title"></b>
	<br>
	<div class="tbl_scrl">
		<table id="hex_view">
			<thead>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>

    <script>
	let fileInput = document.getElementById('rom_fileid');
	fileInput.addEventListener('change', (event) => {
		let file = event.target.files[0];

		if(file.size > ROM_MEMORY_SIZE)
		{
			ERROR_MESSAGE = "ERROR: ROM file uploaded is too big. limit is "+ROM_MEMORY_SIZE+ " bytes, file uploaded is "+file.size+" bytes";
			return;
		}

		if (file) {
			let reader = new FileReader();

			reader.onload = function(event) {
				let arrayBuffer = event.target.result;
				let uint8Array = new Uint8Array(arrayBuffer);
				ROM_MEMORY = uint8Array;
			};

			reader.onerror = function() {
				console.error('Error reading file:', reader.error);
			};

			reader.readAsArrayBuffer(file);
		}
	});
	
	let arr = new Uint8Array(3245)
	for (let i = 0; i < arr.length; i++) {
		//arr[i] = i
		arr[i] = Math.floor(Math.random() * 256); // Generates a random integer between 0 and 255
	}
	
	function byteToHex(byte) {
		let hex = byte.toString(16);

		if (hex.length < 2) {hex = '0' + hex;}

		return hex.toUpperCase();
	}
	
	function build_hex_table(array, tableid)
	{
		let table = document.getElementById(tableid);
		let thead = table.querySelector('thead');
		let tbody = table.querySelector('tbody');
		
		let curr_el = table
		
		console.log(thead+" -- "+tbody)
		
		if(table == null)
			return;
		
		thead.innerHTML = "";
		tbody.innerHTML = "";
		
		let arroff = 0
		let rows = array.length / 16;
		
		rows = Math.trunc(rows)
		
		console.log(rows)
		rows = rows % 16 != 0? rows + 1 : rows;
		console.log(rows)
		
		let columns = 16;
		
		let address_color = "black"
		let address_bck_color = "rgb(130, 200, 198)"
		
		let hex_color = "black"
		let hex_bck_color = "rgb(201, 233, 232)"
		
		let ascii_clr = "black"
		let ascii_bck_clr = "rgb(147, 210, 209)"
		
		let cellw = 1+"em"
		let cellh = 1+"em"
		
		rows++;
		for(let i = 0; i < rows; i++)
		{
			if(i == 0)
				curr_el = thead
			else
				curr_el = tbody
			
			var tr = document.createElement("tr");
			
			//VERTICAL ADDRESS
			var td = document.createElement("td");
			td.textContent =  i == 0? "" : byteToHex((i-1)*0x10); //VERTICAL ROW ADDRESS
			if(i != 0){td.style.color = address_color; td.style.backgroundColor = address_bck_color;}
			td.style.textAlign = "center";
			td.style.width = cellw;
			td.style.height = cellh;
			tr.appendChild(td);
			
			//HEX DATA
			for(let id = 0; id < 16; id++)
			{
				var td = i == 0? document.createElement("th") : document.createElement("td");
				
				if(i == 0)
					td.textContent = byteToHex(id)
				else
					if(arroff+id < array.length)
						td.textContent = byteToHex(array[arroff+id])
					else
						td.textContent = ""
				
				let clr
				let bck_clr
				if(i == 0){clr = address_color;bck_clr = address_bck_color;}
				else{clr = hex_color;bck_clr = hex_bck_color;}
				td.style.color = clr;
				td.style.width = cellw;
				td.style.height = cellh;
				td.style.backgroundColor = bck_clr;
				
				td.style.textAlign = "center";
				tr.appendChild(td);
			}
			
			//ASCI DATA
			for(let ix = 0; ix < 16; ix++)
			{
				var td = document.createElement("td");
				
				if(i == 0)
					td.textContent = ""
				else
					if(arroff+ix < array.length)
						td.textContent = String.fromCharCode(array[arroff+ix])
					else
						td.textContent = ""
				
				if(i != 0){td.style.color = ascii_clr; td.style.backgroundColor = ascii_bck_clr;}
		
				td.style.textAlign = "center";
				td.style.width = cellw;
				td.style.height = cellh;
				tr.appendChild(td);
			}
			
			curr_el.appendChild(tr);
			
			if(i != 0)
				arroff += 16;
		}
		
		var tblScrl = document.querySelector('.tbl_scrl');
		tblScrl.style.width = (table.offsetWidth+25) + 'px';
	}
	
	function show_memory(mem, mname)
	{
		build_hex_table(mem, "hex_view")
		document.getElementById('memory_title').textContent = mname;
	}
	</script>
</body>
</html>
